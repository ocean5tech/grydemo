# 🔧 GRY Demo - 手工部署详细说明

## 📋 部署前准备

### 系统要求
- **操作系统**: Linux / macOS / Windows (WSL)
- **Node.js**: >= 16.0 (推荐 18.x 或更高)
- **内存**: >= 2GB 可用内存
- **磁盘**: >= 1GB 可用空间
- **网络**: 端口 3000, 3001, 8080, 8081 可用

### 可选依赖 (完整Spring Boot版本)
- **Java**: >= 11 (OpenJDK 或 Oracle JDK)
- **Maven**: >= 3.6
- **Docker**: >= 20.x (容器化部署)

---

## 🚀 快速部署 (推荐方式)

### 1. 一键自动部署
```bash
# 进入项目目录
cd /home/wyatt/dev-projects/gry_demo

# 赋予执行权限
chmod +x deploy.sh

# 启动所有服务
./deploy.sh

# 或者使用完整命令
./deploy.sh deploy
```

### 2. 验证部署结果
```bash
# 查看服务状态
./deploy.sh status

# 查看运行日志
./deploy.sh logs

# 执行健康检查
./deploy.sh health
```

### 3. 服务管理命令
```bash
./deploy.sh start    # 启动服务
./deploy.sh stop     # 停止服务
./deploy.sh restart  # 重启服务
./deploy.sh help     # 查看帮助
```

---

## 🔧 手工分步部署

如果一键部署遇到问题，可以按以下步骤手工部署：

### 步骤1: 环境检查

```bash
# 检查Node.js版本
node --version
# 输出应该是 v16.0 或更高

# 检查npm版本
npm --version

# 检查端口占用
ss -tuln | grep -E ":(8080|8081|3000|3001) "
# 应该没有输出，表示端口未被占用

# 如果端口被占用，释放端口
sudo lsof -ti:8080 | xargs kill -9  # 释放8080端口
sudo lsof -ti:8081 | xargs kill -9  # 释放8081端口
sudo lsof -ti:3000 | xargs kill -9  # 释放3000端口
sudo lsof -ti:3001 | xargs kill -9  # 释放3001端口
```

### 步骤2: 创建运行目录

```bash
# 进入项目根目录
cd /home/wyatt/dev-projects/gry_demo

# 创建日志目录
mkdir -p logs

# 创建进程ID目录
mkdir -p pids

# 检查必要文件存在
ls -la *.js *.html
# 应该看到: test-server.js, kafka-demo-server.js, frontend-server.js, kafka-frontend-server.js
# 以及: frontend-test.html, kafka-demo.html
```

### 步骤3: 手工启动各服务

#### 3.1 启动后端API服务 (端口8080)
```bash
# 启动服务
nohup node test-server.js > logs/backend-api.log 2>&1 &

# 记录进程ID
echo $! > pids/backend-api.pid

# 等待服务启动
sleep 3

# 验证服务
curl -s http://localhost:8080/api/users
# 应该返回用户数据JSON
```

#### 3.2 启动Kafka演示服务 (端口8081)
```bash
# 启动服务
nohup node kafka-demo-server.js > logs/kafka-backend.log 2>&1 &

# 记录进程ID
echo $! > pids/kafka-backend.pid

# 等待服务启动
sleep 3

# 验证服务
curl -s http://localhost:8081/api/kafka/status
# 应该返回Kafka状态信息
```

#### 3.3 启动前端测试服务 (端口3000)
```bash
# 启动服务
nohup node frontend-server.js > logs/frontend.log 2>&1 &

# 记录进程ID
echo $! > pids/frontend.pid

# 等待服务启动
sleep 2

# 验证服务
curl -s http://localhost:3000 | grep "GRY Demo"
# 应该返回包含"GRY Demo"的HTML内容
```

#### 3.4 启动Kafka演示前端 (端口3001)
```bash
# 启动服务
nohup node kafka-frontend-server.js > logs/kafka-frontend.log 2>&1 &

# 记录进程ID
echo $! > pids/kafka-frontend.pid

# 等待服务启动
sleep 2

# 验证服务
curl -s http://localhost:3001 | grep "Kafka"
# 应该返回包含"Kafka"的HTML内容
```

### 步骤4: 服务状态检查

```bash
# 检查所有进程是否运行
ps aux | grep -E "(test-server|kafka-demo-server|frontend-server|kafka-frontend-server)" | grep -v grep

# 检查端口监听状态
ss -tuln | grep -E ":(8080|8081|3000|3001) "
# 应该看到4个端口都在监听

# 检查进程ID文件
ls -la pids/
cat pids/*.pid
```

### 步骤5: 功能验证测试

```bash
# 测试后端API
echo "测试后端API..."
curl -s http://localhost:8080/api/users | head -5

echo "测试产品API..."
curl -s -X POST http://localhost:8080/api/products \
  -H "Content-Type: application/json" \
  -d '{"name":"测试产品","price":99.99,"description":"手工部署测试"}'

# 测试Kafka功能
echo "测试Kafka服务..."
curl -s http://localhost:8081/api/kafka/status

echo "创建订单触发Kafka事件..."
curl -s -X POST http://localhost:8081/api/orders \
  -H "Content-Type: application/json" \
  -d '{"userId":1,"items":[{"productId":1,"quantity":2}]}'

# 检查Kafka消息
curl -s http://localhost:8081/api/kafka/messages | tail -10
```

---

## 📱 访问验证

### 浏览器访问测试

1. **基础API测试页面**
   ```
   URL: http://localhost:3000
   功能: 测试5个核心API接口
   验证: 页面加载正常，API按钮可点击
   ```

2. **Kafka异步演示页面** ⭐ **重点推荐**
   ```
   URL: http://localhost:3001
   功能: Kafka消息流可视化演示
   验证: 实时消息监控，事件触发正常
   ```

3. **后端API直接访问**
   ```
   URL: http://localhost:8080/api/users
   功能: 直接测试API响应
   验证: 返回JSON格式用户数据
   ```

4. **Kafka服务状态**
   ```
   URL: http://localhost:8081/api/kafka/status
   功能: 查看Kafka集群状态
   验证: 返回Topic和Consumer信息
   ```

### 命令行功能测试

```bash
# 完整API测试脚本
echo "=== 开始完整功能测试 ==="

# 1. 获取用户列表
echo "1. 测试用户API..."
curl -s http://localhost:8080/api/users | jq '.[0]'

# 2. 创建产品
echo "2. 测试产品创建..."
PRODUCT_ID=$(curl -s -X POST http://localhost:8080/api/products \
  -H "Content-Type: application/json" \
  -d '{"name":"手工测试产品","price":199.99,"description":"手工部署验证产品"}' | jq '.id')

# 3. 更新产品
echo "3. 测试产品更新..."
curl -s -X PUT http://localhost:8080/api/products/$PRODUCT_ID \
  -H "Content-Type: application/json" \
  -d '{"name":"更新的产品","price":299.99,"description":"已更新的产品信息"}'

# 4. 创建订单(触发Kafka)
echo "4. 测试订单创建(Kafka事件)..."
ORDER_ID=$(curl -s -X POST http://localhost:8081/api/orders \
  -H "Content-Type: application/json" \
  -d '{"userId":1,"items":[{"productId":'$PRODUCT_ID',"quantity":3}]}' | jq '.id')

# 5. 多表关联查询
echo "5. 测试多表关联查询..."
curl -s http://localhost:8080/api/orders/user/1 | jq '.[0]'

# 6. 查看Kafka消息
echo "6. 查看Kafka消息流..."
curl -s http://localhost:8081/api/kafka/messages | jq '.[-3:]'

echo "=== 功能测试完成 ==="
```

---

## 🔧 故障排除

### 常见问题及解决方案

#### 1. 端口被占用
**症状**: 服务启动失败，提示端口已被使用
```bash
# 查找占用进程
sudo lsof -i :8080
sudo lsof -i :3000

# 终止占用进程
sudo kill -9 <PID>

# 或者批量终止
sudo pkill -f "test-server.js"
sudo pkill -f "frontend-server.js"
```

#### 2. Node.js版本过低
**症状**: 服务启动时出现语法错误
```bash
# 检查版本
node --version

# 升级Node.js (Ubuntu/Debian)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 升级Node.js (CentOS/RHEL)
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs
```

#### 3. 服务启动但无响应
**症状**: 端口监听但curl连接失败
```bash
# 检查服务日志
tail -f logs/backend-api.log
tail -f logs/kafka-backend.log

# 重启服务
./deploy.sh restart

# 或手工重启
kill $(cat pids/backend-api.pid)
nohup node test-server.js > logs/backend-api.log 2>&1 &
echo $! > pids/backend-api.pid
```

#### 4. 权限问题
**症状**: 无法创建文件或目录
```bash
# 检查目录权限
ls -la /home/wyatt/dev-projects/gry_demo

# 修改权限
chmod -R 755 /home/wyatt/dev-projects/gry_demo
chown -R $USER:$USER /home/wyatt/dev-projects/gry_demo
```

#### 5. 内存不足
**症状**: 服务启动后自动退出
```bash
# 检查内存使用
free -h

# 检查服务内存占用
ps aux --sort=-%mem | head -10

# 如果内存不足，关闭其他服务或增加虚拟内存
```

---

## 🧪 验证部署成功

### 完整验证检查清单

- [ ] **环境检查通过**: Node.js >= 16.0, 端口可用
- [ ] **4个服务启动**: 8080, 8081, 3000, 3001端口监听
- [ ] **基础API工作**: http://localhost:8080/api/users 返回数据
- [ ] **Kafka服务工作**: http://localhost:8081/api/kafka/status 返回状态
- [ ] **前端页面加载**: http://localhost:3000 显示测试界面
- [ ] **Kafka演示页面**: http://localhost:3001 显示监控界面
- [ ] **API功能测试**: 5个核心API均可正常调用
- [ ] **Kafka事件触发**: 创建订单可触发异步消息处理
- [ ] **多表查询工作**: 用户订单关联查询返回正确数据
- [ ] **日志记录正常**: logs目录下有对应的日志文件

### 验证命令汇总

```bash
# 一键验证脚本
echo "=== GRY Demo 部署验证 ==="

# 检查进程
echo "检查服务进程..."
ps aux | grep -E "(test-server|kafka-demo-server|frontend-server)" | grep -v grep

# 检查端口
echo "检查端口监听..."
ss -tuln | grep -E ":(8080|8081|3000|3001) "

# 快速API测试
echo "快速API测试..."
curl -s http://localhost:8080/api/users > /dev/null && echo "✅ 后端API正常" || echo "❌ 后端API异常"
curl -s http://localhost:8081/api/kafka/status > /dev/null && echo "✅ Kafka服务正常" || echo "❌ Kafka服务异常"
curl -s http://localhost:3000 > /dev/null && echo "✅ 前端服务正常" || echo "❌ 前端服务异常"
curl -s http://localhost:3001 > /dev/null && echo "✅ Kafka前端正常" || echo "❌ Kafka前端异常"

echo "=== 验证完成 ==="
echo "推荐访问: http://localhost:3001 体验Kafka异步处理功能"
```

---

## 📚 下一步操作

部署成功后，建议按以下顺序体验系统功能：

1. **访问 http://localhost:3001** - 体验Kafka异步处理演示
2. **访问 http://localhost:3000** - 测试基础API功能
3. **查看 `需求实现对应说明.md`** - 了解代码与需求的对应关系
4. **运行 `./deploy.sh logs`** - 查看实时运行日志
5. **测试API接口** - 使用Postman或curl测试完整API

**手工部署完成！开始体验您的全栈应用吧！** 🎉